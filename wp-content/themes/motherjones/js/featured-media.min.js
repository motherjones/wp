window.console||(console={log:function(){}});var LFM=_.extend(LFM||{},{Utils:{},Views:{},Models:{},Controller:{},instances:{},fetching:!1});!function(){var a,b=jQuery,c=_wpMediaViewsL10n;"ontouchend"in document;LFM.Models.featuredMediaModel=a=Backbone.Model.extend({initialize:function(){Backbone.Model.prototype.initialize.apply(this,arguments),this.set({id:LFM.Utils.getPostId()})},url:ajaxurl,sync:function(a,b,c){var d;d="create"==a||"update"==a?b.toJSON():{},d=_.extend(d,{id:LFM.Utils.getPostId()});var e;if("read"==a)e="largo_featured_media_read";else{if("update"!=a&&"create"!=a)return!1;e="largo_featured_media_save"}var f=c.success,g=c.error;LFM.Utils.doAjax(e,d,f,g)}}),LFM.Views.featuredMediaFrame=wp.media.view.MediaFrame.Select.extend({initialize:function(){_.defaults(this.options,{multiple:!0,editing:!1,state:"image",metadata:{},className:"featured-media-modal",model:new a,states:["image","gallery","video","embed-code"]}),wp.media.view.MediaFrame.Select.prototype.initialize.apply(this,arguments),this.createIframeStates(),this.$el.addClass(this.options.className)},createStates:function(){var a=this.options,b=[new wp.media.controller.FeaturedImage({title:largo_featured_media_vars.image_title,id:"image",priority:10}),new wp.media.controller.EditImage({model:a.editImage})],c=[new wp.media.controller.Library({title:largo_featured_media_vars.gallery_title,id:"gallery",priority:20,toolbar:"main-gallery",filterable:"uploaded",multiple:"add",editable:!1,library:wp.media.query(_.defaults({type:"image"},a.library))}),new wp.media.controller.GalleryEdit({library:a.selection,editing:a.editing,menu:"gallery"}),new wp.media.controller.GalleryAdd],d=[new wp.media.controller.Embed({title:largo_featured_media_vars.video_title,id:"video",priority:30,content:"video"})],e=[new wp.media.controller.Embed({title:largo_featured_media_vars.embed_title,id:"embed-code",priority:40,content:"embed"})];_.indexOf(a.states,"image")>=0&&this.states.add(b),_.indexOf(a.states,"gallery")>=0&&this.states.add(c),_.indexOf(a.states,"video")>=0&&this.states.add(d),_.indexOf(a.states,"embed-code")>=0&&this.states.add(e),LFM.has_featured_media&&this.states.add([new LFM.Controller.removeFeaturedMedia])},bindHandlers:function(){var a;wp.media.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("menu:create:gallery",this.createMenu,this),this.on("toolbar:create:main-gallery",this.createToolbar,this),this.on("toolbar:create:featured-image",this.featuredImageToolbar,this),this.on("toolbar:create:main-embed",this.mainEmbedToolbar,this),a={menu:{default:"mainMenu",gallery:"galleryMenu"},content:{embed:"embedContent",video:"embedVideo","edit-image":"editImageContent","edit-selection":"editSelectionContent",remove:"removeFeaturedMedia"},toolbar:{"main-gallery":"mainGalleryToolbar","gallery-edit":"galleryEditToolbar","gallery-add":"galleryAddToolbar","remove-featured":"removeFeaturedToolbar"}},_.each(a,function(a,b){_.each(a,function(a,c){this.on(b+":render:"+c,this[a],this)},this)},this)},mainMenu:function(a){a.set({"library-separator":new wp.media.View({className:"separator",priority:100})})},removeFeaturedMedia:function(){var a=new LFM.Views.removeFeaturedView({controller:this,model:this.state()});this.content.set(a)},galleryMenu:function(a){var b=this;a.set({cancel:{text:c.cancelGalleryTitle,priority:20,click:function(){b.setState(b.state("gallery")),this.controller.modal.focusManager.focus()}},separateCancel:new wp.media.View({className:"separator",priority:40})})},editImageContent:function(){var a=this.state().get("image"),b=new wp.media.view.EditImage({model:a,controller:this}).render();this.content.set(b),b.loadEditor()},selectionStatusToolbar:function(a){var b=this.state().get("editable");a.set("selection",new wp.media.view.Selection({controller:this,collection:this.state().get("selection"),priority:-40,editable:b&&function(){this.controller.content.mode("edit-selection")}}).render())},mainGalleryToolbar:function(a){var b=this;this.selectionStatusToolbar(a),a.set("gallery",{style:"primary",text:c.createNewGallery,priority:60,requires:{selection:!0},click:function(){var a=b.state().get("selection"),c=b.state("gallery-edit"),d=a.where({type:"image"});c.set("library",new wp.media.model.Selection(d,{props:a.props.toJSON(),multiple:!0})),this.controller.setState("gallery-edit"),this.controller.modal.focusManager.focus()}})},embedVideo:function(){var a=new LFM.Views.featuredVideoView({controller:this,model:this.state()});this.content.set(a)},embedContent:function(){var a=new LFM.Views.featuredEmbedCodeView({controller:this,model:this.state()}).render();this.content.set(a)},editSelectionContent:function(){var a,b=this.state(),d=b.get("selection");a=new wp.media.view.AttachmentsBrowser({controller:this,collection:d,selection:d,model:b,sortable:!0,search:!1,dragInfo:!0,AttachmentView:wp.media.view.Attachment.EditSelection}).render(),a.toolbar.set("backToLibrary",{text:c.returnToLibrary,priority:-100,click:function(){this.controller.content.mode("browse")}}),this.content.set(a)},featuredImageToolbar:function(a){a.view=new LFM.Views.featuredImageToolbar({controller:this})},mainEmbedToolbar:function(a){a.view=new LFM.Views.defaultToolbar({controller:this})},galleryEditToolbar:function(){this.toolbar.set(new LFM.Views.defaultToolbar({controller:this}))},galleryAddToolbar:function(){this.toolbar.set(new wp.media.view.Toolbar({controller:this,items:{insert:{style:"primary",text:c.addToGallery,priority:80,requires:{selection:!0},click:function(){var a=this.controller,b=a.state(),c=a.state("gallery-edit");c.get("library").add(b.get("selection").models),b.trigger("reset"),a.setState("gallery-edit")}}}}))},removeFeaturedToolbar:function(){this.toolbar.set(new LFM.Views.removeFeaturedToolbar({controller:this}))}}),LFM.Views.featuredBaseView=wp.media.View.extend({className:"featured-media-view"}),LFM.Views.featuredEmbeddableView=LFM.Views.featuredBaseView.extend({attachments:new wp.media.model.Attachments,initialize:function(){LFM.Views.featuredBaseView.prototype.initialize.apply(this,arguments);var a=this.controller.model;return this.controller.state().id===a.get("type")&&"undefined"!=typeof a.get("attachment_data")||this.createUploader(),this},render:function(){LFM.Views.featuredBaseView.prototype.render.apply(this,arguments);var a=this.controller.model;if(this.controller.state().id==a.get("type")&&"undefined"!=typeof a.get("attachment_data")){var b=new wp.media.model.Attachment(a.get("attachment_data"));this.updateThumbnail(b)}return this},createUploader:function(){this.attachments.reset([]),this.attachments.observe(wp.Uploader.queue),this.attachments.on("change:uploading",this.uploadProgress.bind(this)),this.on("attachmentUploaded",this.attachmentUploaded.bind(this));var a=new wp.media.view.UploaderInline({controller:this.controller,status:!0,postId:null});this.views.add("#embed-thumb",a)},attachmentUploaded:function(){var a=this.attachments.first();this.updateThumbnail(a),this.off("attachmentUploaded"),this.attachments.off(),this.attachments.unobserve(wp.Uploader.queue)},updateThumbnail:function(a){var b=this;this.thumbnail=new LFM.Views.featuredThumbnail({el:this.$el.find("#embed-thumb"),model:a}).render(),this.thumbnail.on("remove",function(){b.createUploader(),b.thumbnail.off()}),this.attachments.unobserve(wp.Uploader.queue)},uploadProgress:function(){0==this.attachments.first().get("uploading")&&this.trigger("attachmentUploaded")}}),LFM.Views.featuredEmbedCodeView=LFM.Views.featuredEmbeddableView.extend({id:"media-editor-embed-code",template:wp.media.template("featured-embed-code")}),LFM.Views.featuredThumbnail=LFM.Views.featuredBaseView.extend({events:{"click a.remove-thumb":"removeThumb"},template:wp.media.template("featured-thumb"),removeThumb:function(a){var c=b(a.currentTarget);c.parent().remove(),this.trigger("remove")}}),LFM.Views.featuredVideoView=LFM.Views.featuredEmbeddableView.extend({events:{"paste input.url":"fetchVideo","keypress input.url":"fetchVideo"},template:wp.media.template("featured-video"),fetchVideo:function(a){var c=this;if(error=c.$el.find("p.error"),error.html(""),allowedKeyCodes=[86,91,17],allowedLastKeys=[null,91,17],!((a.keyCode in allowedKeyCodes||this.lastKey in allowedLastKeys)&&"paste"!=a.type)){"undefined"!=typeof this.kp&&clearTimeout(this.kp);var d=b('input[name="url"]'),e=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;d.on("input propertychange",function(){c.kp=setTimeout(function(){var a=d.val();e.test(a)?c.fetchMeta(a):error.html(largo_featured_media_vars.error_invalid_url)},100)})}this.kp=a.keyCode},fetchMeta:function(a){var b=this;success=function(a){var c=b.$el.find("p.error");c.html(""),a.embed?b.$el.find("textarea").html(a.embed):c.html(largo_featured_media_vars.error_invalid_url),a.title&&b.$el.find('[name="title"]').val(a.title),a.author_name&&b.$el.find('[name="credit"]').val(a.author_name),b.$el.find('[name="attachment"]').length<1&&b.updateThumbnail(new Backbone.Model(a)),b.hideSpinner()},failure=function(){console.log(largo_featured_media_vars.error_occurred)},this.showSpinner(),LFM.Utils.doAjax("largo_fetch_video_oembed",{action:"largo_fetch_video_oembed",url:a},success,failure)},showSpinner:function(){this.$el.find(".spinner").removeAttr("style")},hideSpinner:function(){this.$el.find(".spinner").css({display:"none"})}}),LFM.Views.defaultToolbar=wp.media.view.Toolbar.extend({saving:!1,initialize:function(){_.defaults(this.options,{items:{submit:{style:"primary",priority:10,requires:!1,text:"Set as featured",click:this.save.bind(this)}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments),this.primary.$el.prepend('<span class="spinner" style="display: none;"></span>')},save:function(){if(!this.saving){var c=this,d=this.controller,e=d.state(),f={};if("image"==e.get("id")){f.type="image";var g=e.get("selection"),h=g.map(function(a){return a.get("id")});h.length>0&&(wp.media.view.settings.post.featuredImageId=h[0],f.attachment=h[0])}else if("gallery-edit"==e.get("id")){f.type="gallery";var i=e.get("library"),h=i.map(function(a){return a.get("id")});h.length>0&&(f.gallery=h)}else f=LFM.Utils.formArrayToObj(d.$el.find("form").serializeArray());this.saving=!0,this.showSpinner(),d.model=new a(f),d.model.save({},{success:function(){c.saving=!1,c.hideSpinner(),b("#set-featured-media-button").html("Edit Featured Media"),LFM.has_featured_media=!0,LFM.instances.modal.close()}})}},showSpinner:function(){this.$el.find(".spinner").removeAttr("style")},hideSpinner:function(){this.$el.find(".spinner").css({display:"none"})}}),LFM.Views.featuredImageToolbar=LFM.Views.defaultToolbar.extend({saving:!1,initialize:function(){_.defaults(this.options,{items:{submit:{style:"primary",priority:10,requires:{selection:!0},text:largo_featured_media_vars.set_featured,click:this.save.bind(this)}}}),LFM.Views.defaultToolbar.prototype.initialize.apply(this,arguments)},save:function(){if(!this.saving){var a=this,b=(this.controller.state(),LFM.Utils.formArrayToObj(this.secondary.$el.find("form").serializeArray()));b.id=LFM.Utils.getPostId(),"undefined"==typeof b["featured-image-display"]?LFM.featured_image_display="":LFM.featured_image_display="on",this.showSpinner(),LFM.Utils.doAjax("largo_save_featured_image_display",b,function(){LFM.Views.defaultToolbar.prototype.save.apply(a,arguments)})}}}),LFM.Views.removeFeaturedToolbar=wp.media.view.Toolbar.extend({initialize:function(){_.defaults(this.options,{items:{submit:{style:"primary",priority:10,requires:!1,text:largo_featured_media_vars.confirm_remove_featured,click:this.clearFeatured.bind(this)}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments),this.primary.$el.prepend('<span class="spinner" style="display: none;"></span>')},clearFeatured:function(){var c=this,d=this.controller;this.showSpinner(),d.model=new a,d.model.save({},{success:function(){c.hideSpinner(),b("#set-featured-media-button").text("Set Featured Media"),LFM.instances.modal.close(),LFM.has_featured_media=!1,wp.media.view.settings.post.featuredImageId=-1}})},showSpinner:function(){this.$el.find(".spinner").removeAttr("style")},hideSpinner:function(){this.$el.find(".spinner").css({display:"none"})}}),LFM.Views.removeFeaturedView=wp.media.View.extend({className:"featured-remove-featured-confirm",template:wp.media.template("featured-remove-featured")}),LFM.Utils.formArrayToObj=function(a){var b={};return _.each(a,function(a){b[a.name]=a.value}),b},LFM.Utils.doAjax=function(a,c,d,e){var f=JSON.stringify(c);params={url:ajaxurl,type:"POST",data:{action:a,data:f},dataType:"json",success:function(a,b,c){d&&d(a,b,c)},error:function(a,b,c){e&&e(a,b,c)}},b.ajax(params)},LFM.Utils.getPostId=function(){return Number(b("#post_ID").val())},LFM.Controller.removeFeaturedMedia=wp.media.controller.State.extend({defaults:{id:"remove",title:largo_featured_media_vars.remove_featured_title,content:"remove",menu:"default",toolbar:"remove-featured",priority:120,type:"link"},initialize:function(a){this.props=new Backbone.Model(this.metadata||{url:""})}}),b(document).ready(function(){b(".set-featured-media").click(function(){if(!LFM.fetching){var c=new a,d=b("#wp-content-media-buttons .spinner");return LFM.fetching=!0,d.show(),c.fetch({success:function(a){function e(a,b){for(var c=[],d=0;d<a.length;d++){a.forEach(function(a,e){b[d]===a.id&&(c[d]=a)})}return c}LFM.fetching=!1,d.hide();var f=wp.media.view.settings.post;"image"==a.get("type")&&0==f.id&&(f.featuredImageId=b("#featured_image_id").val());var g,h=a.get("type")||"image",i=_.findWhere(LFM.options,{id:h}),j={state:i.id,model:c,states:_.map(LFM.options,function(a){return a.id})};if("gallery"==h){j.state="gallery-edit",j.editing=!0;var k=new wp.media.model.Query([],{url:ajaxurl,args:{posts_per_page:-1,post__in:_.map(c.get("gallery"),function(a){return a})}});k.on("sync",function(){var a=e(k.models,k.args.post__in);j.selection=new wp.media.model.Selection(a,{multiple:!0}),g=new LFM.Views.featuredMediaFrame(j),g.open(),LFM.instances.modal=g,k.off("sync")}),k.fetch()}else g=new LFM.Views.featuredMediaFrame(j),g.open(),LFM.instances.modal=g}}),!1}})})}();