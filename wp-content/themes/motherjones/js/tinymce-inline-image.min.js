tinymce.PluginManager.add("wpgallery",function(a){function b(b,c){console.log("ehre");var d=a.dom.getParent(c,"figure.inline-image");d&&(c=d);var e=b;"FIGURE"===c.nodeName&&(e+=" inline-image"),console.log(c),a.dom.setAttrib(c,"class",e)}function c(b){var c=a.dom.getParent(b,"figure.inline-image");c||"IMG"!==b.nodeName||(c=a.dom.getParent(b,"a")),c?(c.nextSibling?a.selection.select(c.nextSibling):c.previousSibling?a.selection.select(c.previousSibling):a.selection.select(c.parentNode),a.selection.collapse(!0),a.dom.remove(c)):a.dom.remove(b),a.nodeChanged(),a.undoManager.add()}function d(b){return!(!a.dom.getAttrib(b,"data-mce-placeholder")&&!a.dom.getAttrib(b,"data-mce-object"))}function e(a){return wp.shortcode.replace("inline_image",a,f)}function f(a){var b=wp.shortcode.replace("caption",a.content,g),c=a.attrs.named.id?'id="'+a.attrs.named.id+'"':"";return"<figure "+c+' class="inline-image align'+a.attrs.named.align+'" style="max-width: '+a.attrs.named.width+'px;">'+b+"</figure>"}function g(a){var b=wp.shortcode.replace("credit",a.content,h);return'<figcaption class="wp-caption-text"><span class="media-caption">'+b+"</span></figcaption>"}function h(a){return'</span><span class="media-credit">'+a.content}function i(a){var b=jQuery("<div>"+a+"</div>");return b.find("figure.inline-image").replaceWith(j),b.html()}function j(){var a=jQuery(this),b=(jQuery(a[0]),a.attr("id")?'id="'+a.attr("id")+'"':""),c=/align([a-zA-Z]+)/.exec(a.attr("class"))[1],d=/([0-9]+)/.exec(a.attr("style"))[1],e=a.find("img").prop("outerHTML");e=e?e+"</img>":"";var f=a.find("span.media-credit"),g=f.html()?"[credit]"+f.html()+"[/credit]":"[credit][/credit]",h=a.find("span.media-caption"),i=h.html()?"[caption]"+h.html()+g+"[/caption]":"[caption]"+g+"[/caption]";return"[inline_image "+b+' align="'+c+'" width="'+d+'"]'+e+i+"[/inline_image]"}a.on("BeforeSetContent",function(a){a.content=e(a.content)}),a.on("PostProcess",function(a){a.get&&(a.content=i(a.content))}),a.on("ResolveName",function(b){var c=a.dom,d=b.target;"FIGURE"===d.nodeName&&c.getAttrib(d,"class").match("align")&&(b.name="Image Container"),"FIGCAPTION"===d.nodeName&&c.hasClass(d,"wp-caption-text")&&(b.name="Image Data"),"SPAN"===d.nodeName&&c.hasClass(d,"media-caption")&&(b.name="Image Caption"),"SPAN"===d.nodeName&&c.hasClass(d,"media-credit")&&(b.name="Image Credit")}),a.on("cut",function(){removeToolbar()}),a.addButton("mj_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){c(a.selection.getNode())}}),tinymce.each({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(c,d){var e=d.slice(5);a.addButton("mj_img_"+d,{tooltip:c,icon:"dashicon dashicons-align-"+e,onclick:function(){console.log("ehre"),b(d,a.selection.getNode())},onPostRender:function(){var b=this;a.on("NodeChange",function(c){var e;e=a.dom.getParent(c.element,".inline-image")||c.element,"FIGURE"===e.nodeName&&("alignnone"===d?b.active(!/\balign(left|center|right)\b/.test(e.className)):b.active(a.dom.hasClass(e,d)))})}})}),a.once("preinit",function(){a.wp&&a.wp._createToolbar&&(toolbar=a.wp._createToolbar(["mj_img_alignleft","mj_img_aligncenter","mj_img_alignright","mj_img_alignnone","mj_img_remove"]))}),a.on("wptoolbar",function(b){console.log(b.element);var c=a.dom.getParent(b.element,"figure.inline-image");console.log(c),(c||"FIGURE"===b.element.nodeName&&a.dom.hasClass(b.element.nodeName,"inline-image"))&&!d(b.element)&&(b.toolbar=toolbar)})});